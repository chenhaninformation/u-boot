U-boot for ESPRESSObin
======================

This branch of U-boot is for ESPRESSObin board and it is based on
[Marvell U-boot](https://github.com/MarvellEmbeddedProcessors/u-boot-marvell "Marvell Armada U-Boot") branch
[u-boot-2017.03-armada-17.10](https://github.com/MarvellEmbeddedProcessors/u-boot-marvell/tree/u-boot-2017.03-armada-17.10).

We only provide the build steps and some notes.
You can find documentation at both the mainline of
[U-boot](https://github.com/u-boot/u-booti "Das U-Boot") and most recent release of
[Marvell U-boot](https://github.com/MarvellEmbeddedProcessors/u-boot-marvell "Marvell Armada U-Boot").

******

Note
====

ESPRESSObin Boot Mode
---------------------

ESPRESSObin have a BOOT ROM on chip, which will support the SoC boot from
different devices by setting up the three jumper descripted
[here](http://wiki.espressobin.net/tiki-index.php?page=Bootloader+recovery+via+UART "Build From Source - Bootloader").

Here is a brief table shown the first boot devices controled by those three
jumpers:

| ESPRESSObin boot mode           |  J10  |  J3   |  J11  |
| :------------------------------ | :---: | :---: | :---: |
| Serial NOR Flash Download Mode  |  1-2  |  2-3  |  2-3  |
| eMMC Download Mode              |  2-3  |  1-2  |  2-3  |
| eMMC Alternate Download Mode    |  1-2  |  1-2  |  2-3  |
| SATA Download Mode              |  2-3  |  2-3  |  1-2  |
| Serial NAND Flash Download Mode |  1-2  |  2-3  |  1-2  |
| UART Mode                       |  2-3  |  1-2  |  1-2  |

Boot requirement
----------------

This U-boot compiled output binary shoud (MUST?) wrapper by the
[ATF (ARM Trusted Firmware)](https://github.com/ARM-software/arm-trusted-firmware "ARM Trusted Firmware")
in order to boot.

After carefully tested, we find that only
[Marvell U-boot](https://github.com/MarvellEmbeddedProcessors/u-boot-marvell "Marvell Armada U-Boot") branch
[u-boot-2017.03-armada-17.10](https://github.com/MarvellEmbeddedProcessors/u-boot-marvell/tree/u-boot-2017.03-armada-17.10) wrappered by
[Marvell ATF](https://github.com/MarvellEmbeddedProcessors/atf-marvell "Marvell Armada ATF") branch
[atf-v1.3-armada-17.10](https://github.com/MarvellEmbeddedProcessors/atf-marvell/tree/atf-v1.3-armada-17.10)
can boot normally without crash the system.

In order to **reduce workload**, we decide to working on those two old
branches rather than fix booting issue by using the most recent release of
U-boot and ATF.

Using the branches above is just a beginning, compile the U-boot with Ubuntu
18.04 default gcc (gcc version 7) will cause the U-boot to access the memory
region reserved by ATF. By carefully tested, **compile the U-boot with gcc-5
can solve the problem**.

***WARNING***: Tested ONLY using Linaro release gcc with version of gcc-5.2
and gcc-5.5. The original gcc-5 was never tested. Tested compiler can be find
[here](http://wiki.espressobin.net/tiki-index.php?page=Build+From+Source+-+Toolchain "Build From Source - Toolchain").

Build Step
==========

Build U-boot
------------

Normal compile step are shown in follow:
```
1. export CROSS_COMPILE=/path/to/aarch64/compiler
2. make defconfig
3. make
```

While in our case, we need download or install gcc-5 instead of using the
default conpiler from Debian/Ubuntu.

**Note**: Put the $PATH at the end of the sentence, make sure we cover the
default finding path /usr/bin.
```
1. export PATH=/path/to/linaro-gcc-5/bin:$PATH
2. export CROSS_COMPILE=aarch64-linux-gnu-
3. make mvebu_espressobin-88f3720_defconfig # espressobin default config file
4. make DEVICE_TREE=armada-3720-espressobin
```

Then you will see a **u-boot.bin** came out at the top directory of U-boot.
Any fether reading of how to compile the U-boot of ESPRESSObin board, please
refer to [here](http://wiki.espressobin.net/tiki-index.php?page=Build+From+Source+-+Bootloader).

Config U-boot
-------------

Some of the CONFIG\_\* is **NOT** generated by Kbuild system, but in the
[configs include directory](/include/configs/), and the build process will
include those files in order to finish the build process.

During build process, file [mvebu\_armada-37xx.h](include/configs/mvebu_armada-37xx.h)
will be included, which will include another file
[mvebu\_armada-common.h](/include/configs/mvebu_armada-common.h), they both
will merged into **.config** file. Some configs will not be configured via
Kbuild, you should edit [mvebu\_armada-common.h](/include/configs/mvebu_armada-common.h)
manually in order to config the build behaviour.

Boot device need be specified during build process, and it can be selected
via Kbuild process:
```
Command line interface -->
	Misc commands -->
		MVEBU commands -->
			Flash for image -->
				SPI flash boot (CONFIG_MVEBU_SPI_BOOT)
				eMMC flash boot (CONFIG_MVEBU_MMC_BOOT)
```
After config the boot device, more configs are selected in file
[mvebu\_armada-common.h](/include/configs/mvebu_armada-common.h) by those two
CONFIG\_\*, including where to store the u-boot environment.

The default boot device is boot from SPI NOR flash, the SPI flash layout may
look like this:
```
-----------------------------------------------------------------
|               U-boot Image                    |   U-boot ENV  |
-----------------------------------------------------------------
0x0                                             0x3f0000        0x400000
```

Where the 0x400000 is the size of the SPI NOR flash, which set default as 4M
byte.

TODO
====

******

Copyright (c) 2018, Hunan ChenHan Information Technology Co., Ltd. All rights reserved.
