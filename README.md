U-boot for ESPRESSObin
======================

This branch of U-boot is for ESPRESSObin board and it is based on
[Marvell U-boot][Marvell U-boot] branch
[u-boot-2017.03-armada-17.10][u-boot-2017.03-armada-17.10].

We only provide the build steps and some notes. You can find documentation at
both the mainline of [U-boot] and most recent release of
[Marvell U-boot][Marvell U-boot].

******

Note
====

ESPRESSObin Boot Mode
---------------------

ESPRESSObin have a BOOT ROM on chip, which will support the SoC boot from
different devices by setting up the three jumper descripted
[here][Build From Source - Bootloader].

Here is a brief table shown the first boot devices controled by those three
jumpers:

| ESPRESSObin boot mode           |  J10  |  J3   |  J11  |
| :------------------------------ | :---: | :---: | :---: |
| Serial NOR Flash Download Mode  |  1-2  |  2-3  |  2-3  |
| eMMC Download Mode              |  2-3  |  1-2  |  2-3  |
| eMMC Alternate Download Mode    |  1-2  |  1-2  |  2-3  |
| SATA Download Mode              |  2-3  |  2-3  |  1-2  |
| Serial NAND Flash Download Mode |  1-2  |  2-3  |  1-2  |
| UART Mode                       |  2-3  |  1-2  |  1-2  |

Boot requirement
----------------

This U-boot compiled output binary shoud (MUST?) wrapper by the
[ATF (ARM Trusted Firmware)][ATF (ARM Trusted Firmware)] in order to boot.

After carefully tested, we find that only [Marvell U-boot] branch
[u-boot-2017.03-armada-17.10] wrappered by [Marvell ATF] branch
[atf-v1.3-armada-17.10] can boot normally without crash the system.

In order to **reduce workload**, we decide to working on those two old
branches rather than fix booting issue by using the most recent release of
U-boot and ATF.

Using the branches above is just a beginning, compile the U-boot with Ubuntu
18.04 default gcc (gcc version 7) will cause the U-boot to access the memory
region reserved by ATF. By carefully tested, **compile the U-boot with gcc-5
can solve the problem**.

***WARNING***: Tested ONLY using Linaro release gcc with version of gcc-5.2
and gcc-5.5. The original gcc-5 was never tested. Tested compiler can be find
[here][Build From Source - Toolchain].

Alter boot flow
---------------

U-boot need to be designed with boot flow alternate capability, our final
product have two button on the fuselage, one button on the back is used to
determining wether we should boot to rescue mode.

Here is some information of how to use GPIO state to alter boot flow in
U-boot, it is referenced from [EE407v01][EE407v01].

> In U-Boot, there is a gpio command utility to set, clear and read the state
> of a given GPIO pin. When used to read the state of a GPIO pin, the status
> is displayed on the console. Unfortunately, the console output cannot be
> **piped or redirected**. So, to use the status of a GPIO pin, modifications
> were made to the existing cmd\_gpio.c file to set the status of a GPIO pin
> in an environment variable.

We will do the same thing to reduce workload by saving environment variable
using C programming language in file [gpio.c][gpio.c], so the upper layer
which can check wether we should boot an alternative rescue image.

Upper layer MUST run "gpio input GPIO25" command to make sure U-boot can get
the newest GPIO state and save it to environmental variable. Upper layer can
access environmental variable "ch\_reset\_button\_pressed" to check wether
user pressed the reset button or not.

(1). Pressed: ch\_reset\_button\_pressed = 1
(2). Not pressed: ch\_reset\_button\_pressed = 0

Build Step
==========

Config U-boot
-------------

Some of the CONFIG\_\* is **NOT** generated by Kbuild system, but in the
[configs include directory][configs include directory], and the build process
will include those files in order to finish the build process.

During build process, file [mvebu\_armada-37xx.h][mvebu_armada-37xx.h]
will be included, which will include another file
[mvebu\_armada-common.h][mvebu_armada-common.h], they both will merged into
**.config** file. Some configs will not be configured via Kbuild, you should
edit [mvebu\_armada-common.h][mvebu_armada-common.h] manually in order to
config the build behaviour.

Boot device need be specified during build process, and it can be selected
via Kbuild process:

```
Command line interface -->
    Misc commands -->
        MVEBU commands -->
            Flash for image -->
                SPI flash boot (CONFIG_MVEBU_SPI_BOOT)
                eMMC flash boot (CONFIG_MVEBU_MMC_BOOT)
```

After config the boot device, more configs are selected in file
[mvebu\_armada-common.h][mvebu_armada-common.h] by those two CONFIG\_\*,
including where to store the u-boot environment.

The default boot device is boot from SPI NOR flash, the SPI flash layout
may look like this:
```
-----------------------------------------------------------------
|               U-boot Image                    |   U-boot ENV  |
-----------------------------------------------------------------
0x0                                             0x3f0000        0x400000
```

Where the 0x400000 is the size of the SPI NOR flash, which set default as 4M
byte.

Build U-boot
------------

### Set correct compiler

We need download or install gcc-5 instead of using the default conpiler from
Debian/Ubuntu.

1. Download [Linaro gcc 5.5.0][Linaro gcc]
2. Unpack it to current directory, using command:
```
tar xvf gcc-linaro-5.5.0-2017.10-x86_64_aarch64-linux-gnu.tar.xz
```
you will see a direcotry gcc-linaro-5.5.0-2017.10-x86\_64\_aarch64-linux-gnu
in current direcotry that contains all files use to compile the U-boot.

### Start to build

```
1. export PATH=/path/to/your/gcc-linaro-5.5.0/bin:$PATH
2. export CROSS_COMPILE=aarch64-linux-gnu-
3. make mvebu_espressobin-88f3720_defconfig
4. make DEVICE_TREE=armada-3720-espressobin
```
**Note**: Put the $PATH at the end of the sentence, make sure we cover the
default finding path /usr/bin, you can verify it by type:
**which aarch64-linux-gnu-gcc** to see if we successfully change the default
compiler to what we need.

Then you will see a **u-boot.bin** came out at the top directory of U-boot.
Any fether reading of how to compile the U-boot of ESPRESSObin board, please
refer to [here][Build From Source - Bootloader].

After Build
===========

As mentioned above, one single **u-boot.bin** can not boot the board, the
output of U-boot **u-boot.bin** should (MUST?) be wrapper by
ARM-Trusted-Firmware.

How to wrapper **u-boot.bin** using ATF?

Please follow the build instruction at [ChenHan ATF][ChenHan ATF] branch
[atf-v1.3-armada-17.10-ch-dev][atf-v1.3-armada-17.10-ch-dev].

The README.md file have some information you may needed.

TODO
====

******

*Copyright (C) 2018, Hunan ChenHan Information Technology Co., Ltd. All rights reserved.*

[U-boot]:				https://github.com/u-boot/u-boot "Das U-Boot"
[Marvell U-boot]:			https://github.com/MarvellEmbeddedProcessors/u-boot-marvell "Marvell Armada U-Boot"
[u-boot-2017.03-armada-17.10]:		https://github.com/MarvellEmbeddedProcessors/u-boot-marvell/tree/u-boot-2017.03-armada-17.10 "u-boot-2017.03-armada-17.10"

[ATF (ARM Trusted Firmware)]:		https://github.com/ARM-software/arm-trusted-firmware "ARM Trusted Firmware"
[Marvell ATF]:				https://github.com/MarvellEmbeddedProcessors/atf-marvell "Marvell Armada ATF"
[atf-v1.3-armada-17.10]:		https://github.com/MarvellEmbeddedProcessors/atf-marvell/tree/atf-v1.3-armada-17.10 "atf-v1.3-armada-17.10"
[ChenHan ATF]:				https://github.com/chenhaninformation/arm-trusted-firmware "ChenHan ATF"
[atf-v1.3-armada-17.10-ch-dev]:		https://github.com/chenhaninformation/arm-trusted-firmware/tree/atf-v1.3-armada-17.10-ch-dev "atf-v1.3-armada-17.10-ch-dev"

[Linaro gcc]:				https://releases.linaro.org/components/toolchain/binaries/5.5-2017.10/aarch64-linux-gnu/gcc-linaro-5.5.0-2017.10-x86_64_aarch64-linux-gnu.tar.xz

[Build From Source - Toolchain]:	http://wiki.espressobin.net/tiki-index.php?page=Build+From+Source+-+Toolchain "Build From Source - Toolchain"
[Build From Source - Bootloader]:	http://wiki.espressobin.net/tiki-index.php?page=Bootloader+recovery+via+UART "Build From Source - Bootloader"

[configs include directory]:		./include/configs/ "./include/configs/"
[mvebu_armada-37xx.h]:			./include/configs/mvebu_armada-37xx.h "mvebu_armada-37xx.h"
[mvebu_armada-common.h]:		./include/configs/mvebu_armada-common.h "mvebu_armada-common.h"

[gpio.c]:				./cmd/gpio.c "gpio.c"

[EE407v01]:				https://www.analog.com/media/en/technical-documentation/application-notes/EE407v01.pdf
